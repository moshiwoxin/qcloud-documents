## 应用场景
当客户将在IDC内自建的容器集群迁移至云上容器服务时，也可选择将自建的容器镜像托管服务一同迁移至云上托管。将自建的镜像仓库服务迁移至云上容器镜像服务，一方面可节省自行搭建及维护的运维管理成本，同时可获得云上专业稳定的托管服务及技术支持，另一方面可实现与云上容器服务联动使用，获得容器上云的一致性使用体验，并可实现容器集群内网拉取镜像以避免公网带宽成本。

Harbor 是 VMware 公司开源的企业级 Docker Registry 项目，在开源 Docker Distribution 能力基础上扩展了如 RBAC，镜像安全扫描，镜像同步等能力，当前已成为自建容器镜像托管，分发服务的首选。本文将介绍如何将在IDC内或云上服务器内搭建的 Harbor 内的容器镜像及Helm Chart 同步至云上容器镜像服务企业版实例。

## 前提条件
在将自建 Harbor 内数据同步至云上容器镜像服务实例内，您需要首先确认并完成以下准备工作：
- 仅支持 Harbor v1.8.0 及以上版本。
- 确认自建 Harbor 可通过专线，公网或私有网络访问容器镜像服务。
- 已在云上容器集群所在地域或邻近地域成功 [创建企业版实例](https://cloud.tencent.com/document/product/1141/40716)。
- 如果使用子账号进行操作，请参考 [企业版授权方案示例](https://cloud.tencent.com/document/product/1141/41417) 提前为子账号授予对应实例的容器镜像，Helm Chart 推送权限，建议授予配置同步的子账号以容器镜像服务全读写权限。

## 操作步骤
### 配置自建 Harbor 服务可访问容器镜像服务企业版实例
#### 方案1：通过公网进行访问
如果当前自建 Harbor 服务未部署在腾讯云私有网络环境内，或无法通过专线打通至腾讯云私有网络，可通过公网进行数据同步。同步过程中可能产生公网流量费用，具体请参考网络运营商或云服务商定价。
1. 登录 [容器镜像服务](https://console.cloud.tencent.com/tcr) 控制台，选择左侧导航栏中的【访问控制】>【公网访问】。
2. 在页面上方的【实例名称】下拉列表中进行选择需要进行数据同步的实例。
3. 点击列表上方的【开启公网访问入口】即可开始开启入口。待该按钮状态由【开启中】变为【关闭公网访问入口】，且【添加公网白名单】为可点击状态，则说明入口已开启。入口开启后，仍默认拒绝全部来源的公网访问。
4. 点击【添加公网白名单】，在新建公网访问白名单配置白名单策略以允许自建 Harbor 服务通过公网访问该实例。其中：
	- **所属实例**：当前已选择实例，即需要进行数据同步的实例。
	- **公网IP地址段**：自建 Harbor 服务出口的公网IP。如果无法确认具体的公网 IP 地址，可临时配置为 0.0.0.0/0 以放通全部公网来源的访问，完成同步后请尽快删除该配置。
	- **备注**：该白名单配置的备注信息，如 “允许自建 Harbor 公网访问”。
![](https://main.qcloudimg.com/raw/23d02b7e38838d203bdb349052bf47b4.png)
 
#### 方案2：通过腾讯云私有网络进行访问
如果当前自建 Harbor 服务部署在腾讯云私有网络环境内，或已通过专线打通至腾讯云私有网络，可通过内网进行数据同步。通过内网进行数据同步将可提升数据同步速度，并节省公网流量费用。
1. 登录 [容器镜像服务](https://console.cloud.tencent.com/tcr) 控制台，选择左侧导航栏中的【访问控制】>【内网访问】。
2. 在页面上方的【实例名称】下拉列表中进行选择需要进行数据同步的实例。
3. 点击【新建】，在新建公网访问白名单配置新建内网访问链路以允许自建 Harbor 服务通过内网访问该实例。其中：
	- **所属实例**：当前已选择实例，即需要进行数据同步的实例。
	- **私有网络**：自建 Harbor 服务所在的私有网络，或通过专线接入的私有网络。
	- **子网**：新建内网访问链路将占用所选私有网络内的一个内网IP，选择私有网络内一个子网以选择该内网IP所在的子网。
![](https://main.qcloudimg.com/raw/8351d60df662bcf4890b43711526d8b7.png)
 
### 获取企业版实例访问凭证
容器镜像服务企业版支持创建，管理多个访问凭证，建议为数据同步操作创建独立的访问凭证，完成数据同步后及时删除，避免实例访问权限泄露。
1. 登录 [容器镜像服务](https://console.cloud.tencent.com/tcr) 控制台，选择左侧导航栏中的【实例列表】。
2. 在“实例列表”页面中选择需要进行数据同步的实例，点击进入实例详情页。
3. 选择【访问凭证】页签，并单击实例列表上方的【新建】。如下图所示：
![](https://main.qcloudimg.com/raw/d5a837707d80efb77577cd94307acf95.png)
4. 在弹出的“新建访问凭证”窗口中，按照以下步骤进行获取：
   1. 在“新建访问凭证”步骤中，输入凭证“用途描述”并单击【下一步】。其中用途描述也填写为 “自建 Harbor 数据同步专用”。
   2. 在“保存访问凭证”步骤中，单击【保存访问凭证】下载凭证信息。**请妥善保管访问凭证，仅一次保存机会**。
创建完成后即可在【访问凭证】页签中查看。当数据同步完成后，请及时进行访问凭证的禁用及删除操作。

### 配置 Harbor 同步仓库及同步规则
Harbor 支持添加第三方 Registry 并配置数据复制规则，本文以 Harbor v2.0.0 为例进行操作说明。
1. 使用管理员账号登录至自建 Harbor 服务，可查看并编辑“系统管理”。
2. 选择【仓库管理】，并点击【新建目标】以添加 TCR 企业版实例，其中：
	- **提供者**：选择 “docker registry”。
	- **目标名**：自定义该同步目标名称，如当前企业版实例名称或ID。
	- **描述**：该目标仓库的描述。
	- **目标URL**：企业版实例访问域名，如 https://harbor-sync.tencentcloudcr.com。
	- **访问ID**：填写上一步骤中新建的实例访问凭证中的登陆用户名。
	- **访问密码**：填写上一步骤中新建的实例访问凭证中的登陆密码。
	- **验证远程证书**：可保持勾选。
3. 点击【测试连接】，如果显示 “测试连接成功” 即说明当前自建 Harbor 服务可以正常访问以上 TCR 企业版实例。如果为测试连接失败，请确认步骤1：配置自建 Harbor 服务可访问容器镜像服务企业版实例。
4. 点击【确定】新建该目标仓库，新建成功后如下图所示：
![](https://main.qcloudimg.com/raw/c2a945389ab6a517c4eb487e0fcd666e.png)
5. 选择【复制管理】，并点击【新建规则】以创建同步规则，其中：
	- **名称**：同步规则名称，可根据具体使用场景填写。
	- **描述**：该复制规则的描述。
	- **复制模式**：仅支持 Push-based。
	- **源资源过滤器**：可过滤选择需要同步的资源，不改动则默认选择自建 Harbor 内全部容器镜像及Helm Chart 资源。
	- **目的Registry**：选择上一步新建的目标仓库。
	- **目的Namespace**：指定目的端的命名空间，不填写则默认是同名命名空间。请注意，同步操作无法在企业版实例侧自动创建命名空间，请提前创建好对应的命名空间。	
	- **触发模式**：默认手动触发，如果需要有新的容器镜像或Helm Chart 推送时自动同步，请选择事件驱动，并建议不要勾选删除本地资源时同时也删除远程的资源。
	- **覆盖**：默认覆盖同名资源。

### 触发同步并查看同步日志
向自建 Harbor 服务内推送镜像，如果同步规则中的触发模式选择为事件驱动，新推送的镜像将自动同步至企业版实例内，可点击该同步规则查看同步日志，并可进入企业版实例控制台查看是否同步成功。
![](https://main.qcloudimg.com/raw/0919b97750d3a5f74b144d96f6359709.png)
![](https://main.qcloudimg.com/raw/ccd13be83b613243a0320201425e45cd.png)
![](https://main.qcloudimg.com/raw/391ea202762bd028bdde9320d746091e.png)

